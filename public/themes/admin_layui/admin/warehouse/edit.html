<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>编辑采集文章</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="stylesheet" href="__TMPL__/public/layui/css/modules/layer/default/layer.css" id="layuicss-layer"   media="all">
    <link rel="stylesheet" href="__TMPL__/public/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__TMPL__/public/style/admin.css" media="all">
    <script type="text/javascript" src="__TMPL__/public/js/jquery.min.js"></script>
    <script type="text/javascript" src="__TMPL__/public/layui/layui.js"></script>
</head>
<body>
<div class="x-body layui-anim layui-anim-up">
    <form method="post" class="layui-form">
        <div class="layui-form-item">
            <label for="title" class="layui-form-label">
                <span class="x-red">文章标题</span>
            </label>
            <div class="layui-input-inline" style="width:70%">
                <input type="text" id="title" name="title" value="{$info.title|default=''}"  autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label  class="layui-form-label">
                <span class="x-red">文章关键词</span>
            </label>
            <div class="layui-input-block" style="width:70%">
                <select name="keyword_id" lay-filter="keyword_id">
                    <option value="" >请选择关键词</option>
                    <volist name="keyword_list" id="vo">
                        <option value="{$vo.id}" <eq name="$vo['id']" value="$info['keyword_id']">selected</eq> >{$vo.keyword}</option>
                    </volist>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label for="url" class="layui-form-label">
                <span class="x-red">文章原始url</span>
            </label>
            <div class="layui-input-inline" style="width:70%">
                <input type="text" id="url" name="url" value="{$info.url|default=''}"  autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label for="author_name" class="layui-form-label">
                <span class="x-red">文章作者</span>
            </label>
            <div class="layui-input-inline" style="width:70%">
                <input type="text" id="author_name" name="author_name" value="{$info.author_name|default=''}"  autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label for="platform_name" class="layui-form-label">
                <span class="x-red">文章来源</span>
            </label>
            <div class="layui-input-inline" style="width:70%">
                <input type="text" id="platform_name" name="platform_name" value="{$info.platform_name|default=''}"  autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label  class="layui-form-label">
                <span class="x-red">文章状态</span>
            </label>
            <div class="layui-input-inline" style="width:70%">
                <input class="layui-input-inline" type="radio" name="status" value="0" title="待审核" <eq name="0" value="$info['status']">checked</eq> >
                <input class="layui-input-inline" type="radio" name="status" value="1" title="通过" <eq name="1" value="$info['status']">checked</eq> >
                <input  class="layui-input-inline"  type="radio" name="status" value="2" title="驳回" <eq name="2" value="$info['status']">checked</eq> >
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">发布时间</span>
            </label>
            <div class="layui-input-inline" style="width:70%;margin-top: 12px;">
                {$info.publish_time|default=''}
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">抓取时间</span>
            </label>
            <div class="layui-input-inline" style="width:70%;margin-top: 12px;">
                {$info.collect_time|default=''}
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">添加时间</span>
            </label>
            <div class="layui-input-inline" style="width:70%;margin-top: 12px;">
                {$info.add_time|default=''}
            </div>
        </div>



        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">文章内容</label>
            <div class="layui-input-block" >
                <button class="layui-btn layui-btn-primary layui-btn-sm" type="button" lay-filter="cleartel" lay-submit="">去除电话</button>
                <button class="layui-btn layui-btn-primary layui-btn-sm" type="button" lay-filter="clearurl" lay-submit="">去除网址</button>
                <textarea id="content" placeholder="请输入内容" name="content"  class="layui-textarea" required="" lay-verify="required">{$info.content|default=''}</textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <input type="hidden" id="data_id" name="data_id" required="" lay-verify="required" value="{$info.data_id}"  autocomplete="off" class="layui-input">
            <button  class="layui-btn" lay-filter="update" lay-submit="">更新</button>
        </div>
    </form>
</div>
<style>
    html{background-color: #fff;color: black;margin-top: 20px;}
</style>
<script type="text/html" id="check">
    <input type="radio" name="layTableCheckbox" value="{{d.data_id}}"  lay-filter="check">
</script>
<script>

    layui.config({
        base: '__TMPL__/public/', //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'form','selectN','selectM','layedit'], function(){
        var $ = layui.$
            ,form = layui.form,
            selectN = layui.selectN;
        //无限级分类-基本配置

        var layedit = layui.layedit;
        var content_index  = layedit.build('content'); //建立编辑器

        //去除电话
        form.on('submit(cleartel)', function(data){
            var body = layedit.getContent(content_index);
            var regx = /^[0]?\d{2,3}[- ]?\d{7,8}$|(?:^1[3456789]|^9[28])\d{9}$/ig;//去除固定电话
            body = matchChar(body,regx);
            regx = /(1[3|4|5|7|8][\d]{9}|0[\d]{2,3}-[\d]{7,8}|400[-]?[\d]{3}[-]?[\d]{4})/g;//去除电话
            body = matchChar(body,regx);
            layedit.setContent(content_index,body);
            layer.msg("电话去除成功！");
            return false;
        });



        //去除网址
        form.on('submit(clearurl)', function(data){
            var body = layedit.getContent(content_index);
            regx = /^((https|http|ftp|rtsp|mms)?:\/\/)[^\s]+/ig;//去除网址
            body = matchChar(body,regx);
            regx = /<\/?a[^>]*>/ig;
            body = matchChar(body,regx);//去除a
            regx = /((http|https):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;
            body = matchChar(body,regx); //去除网址：例如： //http://www.tetet.com/index.html?q=1&m=test
            regx = /[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/;
            for(var i=0;i<=10;i++){
                body = matchChar(body,regx); //去除网址：例如： //http://www.tetet.com/index.html?q=1&m=test
            }
            layedit.setContent(content_index,body);
            layer.msg("网址去除成功！");
            return false;
        });

        //去除特定字符串函数
        function matchChar(str,regx){
            var phoneNums = str.match(regx);
            console.log("debug:"+phoneNums);
            if(phoneNums!=null){
                for(var i= 0;i<phoneNums.length;i++){
                    //手机号全部替换
                    str = str.replace(phoneNums[i],"");
                }
            }
            return str;
        };

        form.on('submit(update)', function(data){
            data.field.content = layedit.getContent(content_index);
            $.ajax({
                url:"{:url('Warehouse/editPost')}",
                data:data.field,
                type:'post',
                dataType:'json',
                success:function(res){
                    if(res.status != 1){
                        layer.msg(res.message, {icon: 5});
                        return false;
                    }else{
                        layer.alert(res.message, {icon: 6},function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            parent.layer.close(index);
                            parent.layui.table.reload('dataTable');
                            // window.parent.location.reload();
                        });
                        return false;
                    }
                },
                error : function(XMLHttpRequest, textStatus, errorThrown) {
                    layer.msg('网络错误！');
                    return false;
                }
            });
            return false;
        });
    });
</script>
</body>
</html>